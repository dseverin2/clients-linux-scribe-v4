#!/bin/bash

echo "--- Configuration de Veyon"
# Configuration de Veyon
str1=`cat /etc/GM_ESU`;
salle="";
config=0;

for a in labo techno info; do
	echo $str1 VS $a
	if [[ "$str1" =~ "$a"* ]]; then
		salle=$a;
		config=1;
		echo Salle $a trouvée pour $str1;
		break;
	fi
done

if [ "$config" = "1" ]; then
	if [ ! -e /usr/bin/veyon-cli ]; then
		sudo apt install -y libfakekey0 libqt5core5a libqt5gui5 libqt5widgets5 libsasl2-2 libxcomposite1 qtbase-abi-5-12-8
		sudo dpkg -i /media/Serveur_Scribe/commun/logiciels/LINUX/libprocps8_3.3.16-1ubuntu2_amd64.deb
		sudo dpkg -i /media/Serveur_Scribe/commun/logiciels/LINUX/veyon_4.5.4-0-ubuntu-focal_amd64.deb
	fi
	echo Importation de la configuration;
	sudo /usr/bin/veyon-cli authkeys import professeurs/private /media/Serveur_Scribe/commun/logiciels/Veyon/Keys/private/professeurs/key
	sudo /usr/bin/veyon-cli authkeys import professeurs/public /media/Serveur_Scribe/commun/logiciels/Veyon/Keys/public/professeurs/key
	sudo /usr/bin/veyon-cli config import /media/Serveur_Scribe/commun/logiciels/Veyon/config.json;
else
	echo Pas de salle trouvée pour $str1;
fi

echo "--- Configuration de la photocopieuse"
# Vérification de la version du gestionnaire de code PIN photocopieuse (Ne jamais enlever)
echo "Recuperation du gestionnaire code de photocopieuse"

sudo wget -nc https://github.com/dseverin2/clients-linux-scribe/raw/master/apps/recup_pin/recup_pin.sh -O /tmp/recup_pin.sh
if [ -s /tmp/recup_pin.sh ]; then
	sudo cmp /tmp/recup_pin.sh /usr/bin/recup_pin/recup_pin.sh 1>/dev/null 2>&1;
	if [ $? -eq 1 ]; then
		sudo mv /tmp/recup_pin.sh /usr/bin/recup_pin/recup_pin.sh
			sudo chmod 0755 /usr/bin/recup_pin/recup_pin.sh
	fi
fi
if [ -e /etc/cups/ppd/PHOTOCOPIEUSE_SDP ]; then
	chmod 0777 /etc/cups/ppd/PHOTOCOPIEUSE_SDP.ppd
fi

echo "--- Configuration du gestionnaire de bureau"
# Vérification de la version du gestionnaire de Bureau (Ne jamais enlever)
echo "Recuperation du gestionnaire de Bureau"
sudo wget -nc https://github.com/dseverin2/clients-linux-scribe/raw/master/esubuntu/esubuntu/background.sh -O /tmp/background.sh
if [ -s /tmp/background.sh ]; then
	sudo cmp /tmp/background.sh /etc/esubuntu/background.sh 1>/dev/null 2>&1;
	if [ $? -eq 1 ]; then
		sudo mv /tmp/background.sh /etc/esubuntu/background.sh
		sudo chmod 0755 /etc/esubuntu/background.sh
	fi
fi

# Vérification de la version du fichier groupe.sh
echo "Recuperation du gestionnaire de groupe EOLE"
sudo wget -nc https://github.com/dseverin2/clients-linux-scribe/raw/master/esubuntu/esubuntu/groupe.sh -O /tmp/groupe.sh
if [ -s /tmp/groupe.sh ]; then
	sudo cmp /tmp/groupe.sh /etc/esubuntu/groupe.sh 1>/dev/null 2>&1;
	if [ $? -eq 1 ]; then
		sudo mv /tmp/groupe.sh /etc/esubuntu/groupe.sh
		sudo chmod 0755 /etc/esubuntu/groupe.sh
	fi
fi
